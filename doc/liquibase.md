# HOW TO SET UP LIQUIBASE AND RUN DATABASE MIGRATION

## 1. About Liquibase
Getting started with Liquibase by refer to its official documentation [here](https://docs.liquibase.com/start/home.html).

## 2. Set up Liquibase in a Spring Boot project
### 2.1. Maven dependencies and plugins
```xml
<dependencies>
  <dependency>
    <groupId>org.liquibase</groupId>
    <artifactId>liquibase-core</artifactId>
  </dependency>
  <dependency>
    <groupId>org.liquibase.ext</groupId>
    <artifactId>liquibase-hibernate6</artifactId>
    <version>4.27.0</version>
  </dependency>
</dependencies>
```
```xml
<plugins>
  <plugin>
    <groupId>org.liquibase</groupId>
    <artifactId>liquibase-maven-plugin</artifactId>
    <configuration>
      <propertyFile>liquibase.properties</propertyFile>
    </configuration>
    <dependencies>
      <dependency>
        <groupId>org.liquibase.ext</groupId>
        <artifactId>liquibase-hibernate6</artifactId>
        <version>4.27.0</version>
      </dependency>
      <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-jpa</artifactId>
        <version>3.3.1</version>
      </dependency>
      <dependency>
        <groupId>jakarta.validation</groupId>
        <artifactId>jakarta.validation-api</artifactId>
        <version>3.0.2</version>
      </dependency>
    </dependencies>
  </plugin>
</plugins>
```

### 2.2. Configuration files
Inside `application.yaml`:
```yaml
spring:
  liquibase:
    change-log: classpath:db/changelog/changelog-master.yaml
```

Create the `liquibase.properties` file in the `src/main/resources` folder:
```properties
changeLogFile=src/main/resources/db/changelog/changelog-master.yaml
url=jdbc:postgresql://localhost:5432/study_jam
username=postgres
password=postgres
referenceUrl=hibernate:spring:com.gdsc.studyjamapi?dialect=org.hibernate.dialect.PostgreSQLDialect&hibernate.physical_naming_strategy=org.hibernate.boot.model.naming.CamelCaseToUnderscoresNamingStrategy&hibernate.implicit_naming_strategy=org.springframework.boot.orm.jpa.hibernate.SpringImplicitNamingStrategy
```
Note that the `referenceUrl` property above is used to enable Liquibase to generate differences between the current database and the persistent entities.

If your connection properties to the local development database are different, change the `liquibase.properties` file but don't commit it.

### 2.3. Create the changelog-master
- Create a new folder `db/changelog` inside `src/main/resources`.
- Create a new file `changelog-master.yaml` inside `db/changelog`.
- Create a new folder `changes` inside `db/changelog`, this folder contains all the generated changelog files.

## 3. Generate changelogs
Each time we change the entities' properties, we need to generate a new changelog and update the `changelog-master.yaml` before running the application, so that the new changes will be logged for further tracking.

Steps to follow:
1. Run this command from the `Makefile`:
    ```shell
    make db-diff
    ```
   It will compare the current database with the updated entities and generate a new changelog located at `src/main/resources/db/changelog/changes`. The file name generated by this way contains a timestamp when the command is executed.
2. Double-check the generated changelog, modify if needed, and write the `rollback` manually for each `changeSet`.
3. Update the `changelog-master.yaml` to include the new changelog.
4. Run the application, check the database to verify if it reflects the new changes.
5. Try rolling back the database to check the `rollback` statements by using this command:
    ```shell
    make db-rollback count=<count>
    ```
   where `<count>` is the number of `changeSet` of the generated changelog.
6. If everything is oke, run the application again to restore the previous state. If we want to remove some changelogs, rollback the database and remove those changelogs in `changlog-master.yaml`
